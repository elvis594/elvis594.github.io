<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED CONTROL</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #ffffff;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1),
                        0 0 0 1px rgba(255, 255, 255, 0.2);
            width: 100%;
            max-width: 600px;
        }
        
        /* 右上角通知样式 */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            min-width: 300px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toast-notification.show {
            transform: translateX(0);
        }
        
        .toast-notification.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.9) 0%, rgba(5, 150, 105, 0.9) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .toast-notification.info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(29, 78, 216, 0.9) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .toast-notification.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.9) 0%, rgba(217, 119, 6, 0.9) 100%);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .toast-notification.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(220, 38, 38, 0.9) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .toast-message {
            font-size: 13px;
            opacity: 0.9;
            line-height: 1.4;
        }

        /* 自定义弹窗样式 */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .custom-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3),
                        0 0 0 1px rgba(255, 255, 255, 0.3);
            transform: scale(0.8) translateY(20px);
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .custom-modal.show .modal-content {
            transform: scale(1) translateY(0);
        }
        
        .modal-icon {
            font-size: 48px;
            margin-bottom: 20px;
            display: block;
        }
        
        .modal-icon.success {
            color: #10b981;
        }
        
        .modal-icon.error {
            color: #ef4444;
        }
        
        .modal-icon.warning {
            color: #f59e0b;
        }
        
        .modal-icon.info {
            color: #3b82f6;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
        }
        
        .modal-message {
            font-size: 16px;
            color: #4b5563;
            line-height: 1.5;
            margin-bottom: 25px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
        }
        
        .modal-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .modal-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .modal-btn.secondary {
            background: rgba(107, 114, 128, 0.1);
            color: #4b5563;
            border: 1px solid rgba(107, 114, 128, 0.2);
        }
        
        .modal-btn.secondary:hover {
            background: rgba(107, 114, 128, 0.2);
            transform: translateY(-1px);
        }
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            font-size: 32px;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
            text-align: left;
            letter-spacing: 0.02em;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
            transition: all 0.3s ease;
        }
        
        .status-indicator.connected {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            margin-top: 40px;
        }

        .connect-button {
            padding: 15px 25px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.4s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            backdrop-filter: blur(15px);
            position: relative;
            overflow: hidden;
        }
        
        .connect-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .connect-button:hover::before {
            left: 100%;
        }
        
        .usb-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4), 0 0 20px rgba(118, 75, 162, 0.3);
        }
        
        .usb-button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6), 0 0 30px rgba(118, 75, 162, 0.5);
        }
        
        .ble-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #ff9ff3 100%);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4), 0 0 20px rgba(238, 90, 36, 0.3);
        }
        
        .ble-button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 35px rgba(255, 107, 107, 0.6), 0 0 30px rgba(238, 90, 36, 0.5);
        }
        
        .connect-button.connected {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4), 0 0 20px rgba(76, 175, 80, 0.3); }
            50% { box-shadow: 0 12px 35px rgba(76, 175, 80, 0.7), 0 0 40px rgba(76, 175, 80, 0.6); }
            100% { box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4), 0 0 20px rgba(76, 175, 80, 0.3); }
        }
        
        .connect-button:active {
            transform: scale(0.98);
        }

        .usb-button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #43e97b 100%);
            color: #ffffff;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4), 0 0 20px rgba(0, 242, 254, 0.3);
        }
        
        .usb-button:hover {
            box-shadow: 0 12px 35px rgba(79, 172, 254, 0.6), 0 0 30px rgba(0, 242, 254, 0.5);
        }
        
        .usb-button.connected {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 50%, #ff6b9d 100%);
            box-shadow: 0 8px 25px rgba(255, 65, 108, 0.4), 0 0 20px rgba(255, 75, 43, 0.3);
        }
        
        .usb-button.connected:hover {
            box-shadow: 0 12px 35px rgba(255, 65, 108, 0.6), 0 0 30px rgba(255, 75, 43, 0.5);
        }

        .ble-button {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 50%, #ff6b9d 100%);
            color: #ffffff;
            box-shadow: 0 8px 25px rgba(250, 112, 154, 0.4), 0 0 20px rgba(254, 225, 64, 0.3);
        }
        
        .ble-button:hover {
            box-shadow: 0 12px 35px rgba(250, 112, 154, 0.6), 0 0 30px rgba(254, 225, 64, 0.5);
        }
        
        .ble-button.connected {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 50%, #ff6b9d 100%);
            box-shadow: 0 8px 25px rgba(255, 65, 108, 0.4), 0 0 20px rgba(255, 75, 43, 0.3);
        }
        
        .ble-button.connected:hover {
            box-shadow: 0 12px 35px rgba(255, 65, 108, 0.6), 0 0 30px rgba(255, 75, 43, 0.5);
        }


        /* 开关控件行样式 */
        .switches-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }
        
        /* 控件组样式 */
        .control-group {
            margin-bottom: 32px;
        }
        
        .switches-row .control-group {
            margin-bottom: 0;
            text-align: center;
        }
        
        .switches-row .control-group label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 16px;
            letter-spacing: 0.02em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .control-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 12px;
            letter-spacing: 0.02em;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }
        
        /* 开关按钮样式 */
        .switch-container {
            display: flex;
            justify-content: center;
        }
        
        .switch-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s ease;
            min-width: 120px;
            letter-spacing: 0.02em;
            backdrop-filter: blur(15px);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
        }
        
        .switch-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }
        
        .switch-btn:hover::before {
            left: 100%;
        }
        
        .switch-btn.off {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 50%, #ff6b9d 100%);
            color: #ffffff;
            box-shadow: 0 8px 25px rgba(255, 65, 108, 0.4), 0 0 20px rgba(255, 75, 43, 0.3);
        }
        
        .switch-btn.on {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 50%, #4facfe 100%);
            color: #ffffff;
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4), 0 0 20px rgba(56, 239, 125, 0.3);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        .switch-btn:hover {
            transform: translateY(-3px) scale(1.05);
        }
        
        .switch-btn.off:hover {
            box-shadow: 0 12px 35px rgba(255, 65, 108, 0.6), 0 0 30px rgba(255, 75, 43, 0.5);
        }
        
        .switch-btn.on:hover {
            box-shadow: 0 12px 35px rgba(17, 153, 142, 0.6), 0 0 30px rgba(56, 239, 125, 0.5);
        }
        
        @keyframes glow {
            from { box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4), 0 0 20px rgba(56, 239, 125, 0.3); }
            to { box-shadow: 0 8px 25px rgba(17, 153, 142, 0.6), 0 0 30px rgba(56, 239, 125, 0.6); }
        }
         
        /* 连接状态样式 */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 16px;
        }
         
        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s ease;
            position: relative;
        }
        
        .status-indicator::before {
            content: '';
            position: relative;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
            box-shadow: 0 0 10px rgba(255, 71, 87, 0.6);
            transition: all 0.4s ease;
            flex-shrink: 0;
        }
        
        .status-indicator.connected::before {
            background: #2ed573;
            box-shadow: 0 0 15px rgba(46, 213, 115, 0.6);
            animation: connectedPulse 2s ease-in-out infinite;
        }
        
        .status-indicator.connecting::before {
            background: #ffa502;
            box-shadow: 0 0 15px rgba(255, 165, 2, 0.6);
            animation: connectingBlink 1s ease-in-out infinite;
        }
        
        @keyframes connectedPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        
        @keyframes connectingBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        #connectionStatus {
            font-size: 12px;
            font-weight: 600;
            color: #ffffff;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
         
        .disconnect-btn {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 50%, #ff6b9d 100%);
            color: #ffffff;
            border: none;
            border-radius: 12px;
            padding: 14px 28px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.4s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(255, 65, 108, 0.4), 0 0 20px rgba(255, 75, 43, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .disconnect-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }
        
        .disconnect-btn:hover::before {
            left: 100%;
        }
         
        .disconnect-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 35px rgba(255, 65, 108, 0.6), 0 0 30px rgba(255, 75, 43, 0.5);
        }
        
        /* 滑块样式 */
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
            margin: 16px 0;
            border: none;
            backdrop-filter: blur(10px);
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .control-group span {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            margin-top: 8px;
            display: inline-block;
            letter-spacing: 0.02em;
        }
        
        /* 控件网格布局 */
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            margin-top: 20px;
        }
        
        .sliders-section {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }
        
        .color-section {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        
        /* 调色盘样式 */
        .color-picker-control {
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .color-wheel-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        #colorWheel {
            border-radius: 50%;
            cursor: crosshair;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .color-picker {
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 10;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .color-info {
            display: flex;
            justify-content: center;
        }
        
        .selected-color {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background-color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* 图标样式 */
        @font-face {
            font-family: 'Material Icons';
            font-style: normal;
            font-weight: 400;
            src: url(https://fonts.gstatic.com/s/materialicons/v139/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2) format('woff2');
        }

        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 20px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
            color: #4a5568;
        }
        
        /* 控制组标签样式 */
        .control-group label {
            display: block;
            margin-bottom: 12px;
            color: #2d3748;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.025em;
        }
        
        .color-picker-control label {
            display: block;
            margin-bottom: 20px;
            color: #2d3748;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.025em;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 标题和状态行 -->
        <div class="header-row">
            <h1>LED CONTROL</h1>
            <div class="connection-status">
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="connectionStatus">DISCONNECTED</span>
                </div>
            </div>
        </div>
        
        <!-- 连接按钮 -->
        <div class="button-group">
            <button class="connect-button usb-button" id="usbConnect">
                <span class="material-icons">usb</span> <span id="usbText">USB</span>
            </button>
            <button class="connect-button ble-button" id="bleConnect">
                <span class="material-icons">bluetooth</span> <span id="bleText">BLE</span>
            </button>
        </div>
        

        <!-- 开关控件行 -->
        <div class="switches-row">
            <div class="control-group">
                <label>💡 LED:</label>
                <button id="ledSwitch" class="switch-btn off" data-state="off">
                    <span class="switch-text">💡</span>
                </button>
            </div>
            
            <div class="control-group">
                <label>🌊 BREATH:</label>
                <button id="breatheSwitch" class="switch-btn off" data-state="off">
                    <span class="switch-text">🌊</span>
                </button>
            </div>
        </div>
        
        <!-- 滑块和调色盘网格布局 -->
        <div class="controls-grid">
            <div class="sliders-section">
                <div class="control-group">
                    <label>⚡ FREQUENCY:</label>
                    <input type="range" id="breathePeriod" min="100" max="5000" value="1000" class="slider">
                    <span id="breathePeriodValue">1000MS</span>
                </div>
                
                <div class="control-group">
                    <label>☀️ BRIGHTNESS:</label>
                    <input type="range" id="brightness" min="0" max="100" value="50" step="1" class="slider">
                    <span id="brightnessValue">50%</span>
                </div>
            </div>
            
            <div class="color-section">
                <div class="color-picker-control">
                    <label>🎨 COLOR:</label>
                    <div class="color-wheel-container">
                        <canvas id="colorWheel" width="180" height="180"></canvas>
                        <div class="color-picker" id="colorPicker"></div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <script>
        // 亮度滑块功能

        
        // 全局变量
        let serialPort = null;
        let serialReader = null;
        let bluetoothDevice = null;
        let bluetoothCharacteristic = null;
        
        // 调色盘功能
        const colorWheel = document.getElementById('colorWheel');
        const colorPicker = document.getElementById('colorPicker');
        // const selectedColor = document.getElementById('selectedColor'); // 已移除selectedColor元素
        const rgbValue = null; // 移除对已删除元素的引用
        const hexValue = null; // 移除对已删除元素的引用
        const ctx = colorWheel.getContext('2d');
     let currentColor = { r: 255, g: 255, b: 255 };
        
        // 绘制HSV颜色轮
         function drawColorWheel() {
             const centerX = colorWheel.width / 2;
             const centerY = colorWheel.height / 2;
             const radius = Math.min(centerX, centerY) - 10;
             
             // 清除画布
             ctx.clearRect(0, 0, colorWheel.width, colorWheel.height);
             
             // 使用像素级绘制创建平滑的颜色轮
             const imageData = ctx.createImageData(colorWheel.width, colorWheel.height);
             const data = imageData.data;
             
             for (let y = 0; y < colorWheel.height; y++) {
                 for (let x = 0; x < colorWheel.width; x++) {
                     const dx = x - centerX;
                     const dy = y - centerY;
                     const distance = Math.sqrt(dx * dx + dy * dy);
                     
                     if (distance <= radius) {
                         // 计算角度和饱和度
                         let angle = Math.atan2(dy, dx);
                         if (angle < 0) angle += 2 * Math.PI;
                         const hue = (angle / (2 * Math.PI)) * 360;
                         const saturation = Math.min(distance / radius, 1) * 100;
                         // 固定亮度为50%
                         const lightness = 50;
                         
                         // 转换HSL到RGB
                         const rgb = hslToRgb(hue, saturation, lightness);
                         
                         const index = (y * colorWheel.width + x) * 4;
                         data[index] = rgb.r;     // Red
                         data[index + 1] = rgb.g; // Green
                         data[index + 2] = rgb.b; // Blue
                         data[index + 3] = 255;   // Alpha
                     } else {
                         // 圆形外部设为透明
                         const index = (y * colorWheel.width + x) * 4;
                         data[index + 3] = 0; // 透明
                     }
                 }
             }
             
             ctx.putImageData(imageData, 0, 0);
         }
        
        // HSL转RGB
        function hslToRgb(h, s, l) {
            h /= 360;
            s /= 100;
            l /= 100;
            
            const c = (1 - Math.abs(2 * l - 1)) * s;
            const x = c * (1 - Math.abs((h * 6) % 2 - 1));
            const m = l - c / 2;
            
            let r, g, b;
            
            if (0 <= h && h < 1/6) {
                r = c; g = x; b = 0;
            } else if (1/6 <= h && h < 2/6) {
                r = x; g = c; b = 0;
            } else if (2/6 <= h && h < 3/6) {
                r = 0; g = c; b = x;
            } else if (3/6 <= h && h < 4/6) {
                r = 0; g = x; b = c;
            } else if (4/6 <= h && h < 5/6) {
                r = x; g = 0; b = c;
            } else {
                r = c; g = 0; b = x;
            }
            
            return {
                r: Math.round((r + m) * 255),
                g: Math.round((g + m) * 255),
                b: Math.round((b + m) * 255)
            };
        }
        
        // RGB转HEX
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        }
        
        // 更新颜色显示
        function updateColorDisplay(color) {
            currentColor = color;
            // selectedColor.style.backgroundColor = `rgb(${color.r}, ${color.g}, ${color.b})`; // 已移除selectedColor元素
            
            // 发送颜色数据
            sendColorData(color);
        }
        
        // 拖拽状态
        let isDragging = false;
        
        // 处理颜色选择的通用函数
        function handleColorSelection(e) {
            const rect = colorWheel.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const centerX = colorWheel.width / 2;
            const centerY = colorWheel.height / 2;
            const dx = x - centerX;
            const dy = y - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const radius = Math.min(centerX, centerY) - 10;
            
            // 只在圆形区域内处理
            if (distance <= radius) {
                // 计算角度和饱和度
                let angle = Math.atan2(dy, dx);
                if (angle < 0) angle += 2 * Math.PI;
                const hue = (angle / (2 * Math.PI)) * 360;
                const saturation = Math.min(distance / radius, 1) * 100;
                const lightness = 50;
                
                const color = hslToRgb(hue, saturation, lightness);
                updateColorDisplay(color);
                
                // 更新选择器位置
                colorPicker.style.left = x + 'px';
                colorPicker.style.top = y + 'px';
                
                return true;
            }
            return false;
        }
        
        // 鼠标按下事件
        colorWheel.addEventListener('mousedown', function(e) {
            if (handleColorSelection(e)) {
                isDragging = true;
                colorWheel.style.cursor = 'grabbing';
            }
        });
        
        // 鼠标移动事件
        colorWheel.addEventListener('mousemove', function(e) {
            if (isDragging) {
                handleColorSelection(e);
            } else {
                // 检查鼠标是否在颜色轮内
                const rect = colorWheel.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const centerX = colorWheel.width / 2;
                const centerY = colorWheel.height / 2;
                const radius = Math.min(centerX, centerY) - 10;
                const dx = x - centerX;
                const dy = y - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance <= radius) {
                    colorWheel.style.cursor = 'grab';
                } else {
                    colorWheel.style.cursor = 'default';
                }
            }
        });
        
        // 鼠标抬起事件
        colorWheel.addEventListener('mouseup', function() {
            isDragging = false;
            colorWheel.style.cursor = 'grab';
        });
        
        // 鼠标离开事件
        colorWheel.addEventListener('mouseleave', function() {
            isDragging = false;
            colorWheel.style.cursor = 'default';
        });
        
        // 处理颜色轮点击（保持向后兼容）
        colorWheel.addEventListener('click', function(e) {
            if (!isDragging) {
                handleColorSelection(e);
            }
        });
        
        // 蓝牙和串口通信变量
         const CHARACTERISTIC_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';
         
         // 连接状态管理
         let connectionType = null; // 'bluetooth' 或 'serial'
         let isConnected = false;
         
         // 更新连接状态显示
         function updateConnectionStatus(status, type = null) {
             const statusIndicator = document.querySelector('.status-indicator');
             const connectionStatus = document.getElementById('connectionStatus');
             const usbButton = document.getElementById('usbConnect');
             const bleButton = document.getElementById('bleConnect');
             const usbText = document.getElementById('usbText');
             const bleText = document.getElementById('bleText');
             
             // 清除所有状态类
             statusIndicator.className = 'status-indicator';
             usbButton.className = 'connect-button usb-button';
             bleButton.className = 'connect-button ble-button';
             
             switch(status) {
                 case 'disconnected':
                     connectionStatus.textContent = 'DISCONNECTED';
                     usbText.textContent = 'USB';
                     bleText.textContent = 'BLE';
                     isConnected = false;
                     connectionType = null;
                     break;
                 case 'connecting':
                     connectionStatus.textContent = 'CONNECTING';
                     statusIndicator.classList.add('connecting');
                     if (type === 'serial') {
                         usbText.textContent = '连接中...';
                     } else if (type === 'bluetooth') {
                         bleText.textContent = '连接中...';
                     }
                     isConnected = false;
                     break;
                 case 'connected':
                     connectionStatus.textContent = type === 'serial' ? 'USB CONNECTED' : 'BLE CONNECTED';
                     statusIndicator.classList.add('connected');
                     if (type === 'serial') {
                         usbButton.classList.add('connected');
                         usbText.textContent = '断开USB';
                         bleText.textContent = 'BLE';
                     } else if (type === 'bluetooth') {
                         bleButton.classList.add('connected');
                         bleText.textContent = '断开BLE';
                         usbText.textContent = 'USB';
                     }
                     isConnected = true;
                     connectionType = type;
                     break;
             }
             
             // 更新控件状态
             updateControlsState();
         }
         
         // 更新控件启用/禁用状态
         function updateControlsState() {
             const controls = [
                 'ledSwitch', 'breatheSwitch', 'breathePeriod', 'brightness'
             ];
             
             controls.forEach(id => {
                 const element = document.getElementById(id);
                 if (element) {
                     element.disabled = !isConnected;
                     if (!isConnected) {
                         element.style.opacity = '0.5';
                         element.style.pointerEvents = 'none';
                     } else {
                         element.style.opacity = '1';
                         element.style.pointerEvents = 'auto';
                     }
                 }
             });
             
             // 禁用/启用调色盘
             const canvas = document.getElementById('colorWheel');
             if (canvas) {
                 if (!isConnected) {
                     canvas.style.opacity = '0.5';
                     canvas.style.pointerEvents = 'none';
                 } else {
                     canvas.style.opacity = '1';
                     canvas.style.pointerEvents = 'auto';
                 }
             }
             
             // 确保连接按钮始终可用
             const bleConnect = document.getElementById('bleConnect');
             const usbConnect = document.getElementById('usbConnect');
             
             if (bleConnect) {
                 bleConnect.style.opacity = '1';
                 bleConnect.style.pointerEvents = 'auto';
                 bleConnect.disabled = false;
             }
             
             if (usbConnect) {
                 usbConnect.style.opacity = '1';
                 usbConnect.style.pointerEvents = 'auto';
                 usbConnect.disabled = false;
             }
         }
        
        // 蓝牙连接功能
         async function connectBluetooth() {
             // 检查是否已有其他连接
             if (isConnected && connectionType === 'serial') {
                 alert('请先断开USB连接');
                 return;
             }
             
             if (isConnected && connectionType === 'bluetooth') {
                 alert('蓝牙已连接');
                 return;
             }
             
             updateConnectionStatus('connecting');
             
             try {
                 bluetoothDevice = await navigator.bluetooth.requestDevice({
                     filters: [{ services: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e'] }]
                 });
                 
                 const server = await bluetoothDevice.gatt.connect();
                 const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
                 bluetoothCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                 
                 console.log('蓝牙连接成功');
                 updateConnectionStatus('connected', 'bluetooth');
                 
                 // 监听断开事件
                 bluetoothDevice.addEventListener('gattserverdisconnected', () => {
                     console.log('蓝牙设备断开连接');
                     bluetoothDevice = null;
                     bluetoothCharacteristic = null;
                     updateConnectionStatus('disconnected');
                 });
                 
             } catch (error) {
                 console.error('蓝牙连接失败:', error);
                 updateConnectionStatus('disconnected');
                 
                 // 如果用户取消选择设备，不显示错误提示
                 if (error.name !== 'NotFoundError' && !error.message.includes('User cancelled')) {
                     alert('蓝牙连接失败: ' + error.message);
                 }
             }
         }
         
         // 串口连接功能
         async function connectSerial() {
             // 检查是否已有其他连接
             if (isConnected && connectionType === 'bluetooth') {
                 alert('请先断开蓝牙连接');
                 return;
             }
             
             if (isConnected && connectionType === 'serial') {
                 alert('USB已连接');
                 return;
             }
             
             updateConnectionStatus('connecting');
             
             try {
                 serialPort = await navigator.serial.requestPort();
                 await serialPort.open({ baudRate: 115200 });
                 console.log('串口连接成功');
                 updateConnectionStatus('connected', 'serial');
             } catch (error) {
                 console.error('串口连接失败:', error);
                 updateConnectionStatus('disconnected');
                 alert('串口连接失败: ' + error.message);
             }
         }
        
        // 断开连接功能
        async function disconnect() {
            try {
                if (connectionType === 'bluetooth' && bluetoothDevice) {
                    stopBluetoothConnectionMonitor();
                    if (bluetoothDevice.gatt.connected) {
                        bluetoothDevice.gatt.disconnect();
                    }
                    bluetoothDevice = null;
                    bluetoothCharacteristic = null;
                    console.log('蓝牙连接已断开');
                } else if (connectionType === 'serial' && serialPort) {
                    console.log('正在关闭串口连接...');
                    
                    // 先取消并释放reader
                    if (serialReader) {
                        try {
                            await serialReader.cancel();
                            serialReader.releaseLock();
                        } catch (e) {
                            console.log('Reader取消失败，可能已经被释放:', e.message);
                        }
                        serialReader = null;
                    }
                    
                    // 然后关闭串口
                    await serialPort.close();
                    serialPort = null;
                    console.log('串口连接已断开');
                    // 等待一小段时间确保端口完全释放
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                updateConnectionStatus('disconnected');
            } catch (error) {
                console.error('断开连接失败:', error);
                // 即使断开失败，也要重置变量和状态
                if (connectionType === 'serial') {
                    serialPort = null;
                    serialReader = null;
                }
                updateConnectionStatus('disconnected');
            }
        }
        
        // 蓝牙发送互斥锁
        let isSendingBluetooth = false;
        
        // 发送指令到设备
        async function sendCommand(command) {
            if (!isConnected) {
                console.warn('设备未连接，无法发送指令');
                return;
            }
            
            console.log('发送指令:', command);
            
            // 蓝牙发送
            if (bluetoothCharacteristic) {
                // 如果正在发送，跳过这次发送
                if (isSendingBluetooth) {
                    console.log('蓝牙正在发送中，跳过:', command);
                    return;
                }
                
                isSendingBluetooth = true;
                try {
                    const encoder = new TextEncoder();
                    await bluetoothCharacteristic.writeValue(encoder.encode(command));
                    console.log('蓝牙发送成功:', command);
                } catch (error) {
                    console.error('蓝牙发送失败:', error);
                    // 只有在连接真正断开时才更新状态
                    if (error.name === 'NetworkError' || error.message.includes('GATT Server is disconnected')) {
                        updateConnectionStatus('disconnected');
                    }
                } finally {
                    isSendingBluetooth = false;
                }
            }
            
            // 串口发送
            if (serialPort && serialPort.writable) {
                try {
                    const writer = serialPort.writable.getWriter();
                    const encoder = new TextEncoder();
                    await writer.write(encoder.encode(command + '\n'));
                    writer.releaseLock();
                    console.log('串口发送成功:', command);
                } catch (error) {
                    console.error('串口发送失败:', error);
                    // 只有在端口真正断开时才更新状态
                    if (error.name === 'NetworkError' || !serialPort.readable) {
                        updateConnectionStatus('disconnected');
                    }
                }
            }
        }
        
        // 颜色发送防抖定时器
        let colorSendTimer = null;
        // 亮度发送防抖定时器
        let brightnessSendTimer = null;
        
        // 发送颜色数据
        function sendColorData(color) {
            if (color) {
                // 清除之前的定时器
                if (colorSendTimer) {
                    clearTimeout(colorSendTimer);
                }
                
                // 设置新的定时器，10ms后发送（进一步加快响应速度）
                colorSendTimer = setTimeout(() => {
                    const command = `${color.r},${color.g},${color.b}`;
                    sendCommand(command);
                    colorSendTimer = null;
                }, 10);
            }
        }
        
        // 发送亮度数据（带防抖）
        function sendBrightnessData(value) {
            // 清除之前的定时器
            if (brightnessSendTimer) {
                clearTimeout(brightnessSendTimer);
            }
            
            // 设置新的定时器，300ms后发送（降低频率）
            brightnessSendTimer = setTimeout(() => {
                sendCommand('BRIGHT ' + value + '%');
                brightnessSendTimer = null;
            }, 300);
        }
        

        
        // LED开关事件处理
        document.getElementById('ledSwitch').addEventListener('click', function() {
            const btn = this;
            const currentState = btn.getAttribute('data-state');
            
            if (currentState === 'off') {
                btn.setAttribute('data-state', 'on');
                btn.className = 'switch-btn on';
                if (btn.id === 'ledSwitch') {
                    btn.querySelector('.switch-text').textContent = '💡';
                } else if (btn.id === 'breatheSwitch') {
                    btn.querySelector('.switch-text').textContent = '🌊';
                }
                sendCommand('ON');
            } else {
                btn.setAttribute('data-state', 'off');
                btn.className = 'switch-btn off';
                if (btn.id === 'ledSwitch') {
                    btn.querySelector('.switch-text').textContent = '💡';
                } else if (btn.id === 'breatheSwitch') {
                    btn.querySelector('.switch-text').textContent = '🌊';
                }
                sendCommand('OFF');
            }
        });
        
        // 呼吸灯开关事件处理
        document.getElementById('breatheSwitch').addEventListener('click', function() {
            const btn = this;
            const currentState = btn.getAttribute('data-state');
            
            if (currentState === 'off') {
                btn.setAttribute('data-state', 'on');
                btn.className = 'switch-btn on';
                btn.querySelector('.switch-text').textContent = '🌊';
                sendCommand('BREATHE ON');
            } else {
                btn.setAttribute('data-state', 'off');
                btn.className = 'switch-btn off';
                btn.querySelector('.switch-text').textContent = '🌊';
                sendCommand('BREATHE OFF');
            }
        });
        
        // 闪烁频率滑块事件处理
         document.getElementById('breathePeriod').addEventListener('input', function() {
             const value = this.value;
             document.getElementById('breathePeriodValue').textContent = value + 'ms';
             sendCommand('BREATHE PERIOD ' + value);
         });
         
         // 亮度滑块事件处理
         document.getElementById('brightness').addEventListener('input', function() {
             const value = this.value;
             document.getElementById('brightnessValue').textContent = value + '%';
             sendBrightnessData(value);
         });
        
        // 初始化调色盘
        drawColorWheel();
        
        // 设置初始选择器位置（中心白色）
         colorPicker.style.left = (colorWheel.width / 2) + 'px';
         colorPicker.style.top = (colorWheel.height / 2) + 'px';
         updateColorDisplay(currentColor);
         
         // 初始化连接状态
         updateConnectionStatus('disconnected');
        
        // 连接按钮事件已整合到USB和BLE按钮中
        
        // USB连接按钮
        document.getElementById('usbConnect').addEventListener('click', async function() {
            try {
                // 如果已连接且是USB连接，则断开
                if (isConnected && connectionType === 'serial') {
                    await disconnect();
                    return;
                }
                
                // 如果已连接但是其他类型，提示用户
                if (isConnected && connectionType !== 'serial') {
                    showCustomAlert('请先断开当前连接', 'warning', '连接冲突');
                    return;
                }
                
                // 检查浏览器是否支持Web Serial API
                if (!('serial' in navigator)) {
                    showCustomAlert('您的浏览器不支持Web Serial API，请使用Chrome或Edge浏览器', 'warning', '浏览器不支持');
                    return;
                }
                
                updateConnectionStatus('connecting', 'serial');
                
                // 请求串口权限
                serialPort = await navigator.serial.requestPort();
                
                // 打开串口连接
                await serialPort.open({ 
                    baudRate: 115200,
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none'
                });
                
                showToast('USB连接成功！', 'success', '连接成功');
                
                // 更新连接状态
                updateConnectionStatus('connected', 'serial');
                
                // 监听串口数据
                readSerialData();
                
                // 主动获取设备状态
                console.log('发送GET STATE命令获取设备状态');
                await sendSerialData('GET STATE\n');
                
            } catch (error) {
                console.error('USB操作失败:', error);
                updateConnectionStatus('disconnected');
            }
        });
        
        // BLE连接按钮
        document.getElementById('bleConnect').addEventListener('click', async function() {
            try {
                // 如果已连接且是BLE连接，则断开
                if (isConnected && connectionType === 'bluetooth') {
                    await disconnect();
                    return;
                }
                
                // 如果已连接但是其他类型，提示用户
                 if (isConnected && connectionType !== 'bluetooth') {
                     showCustomAlert('请先断开当前连接', 'warning', '连接冲突');
                     return;
                 }
                
                // 检查浏览器是否支持Web Bluetooth API
                if (!('bluetooth' in navigator)) {
                    showCustomAlert('您的浏览器不支持Web Bluetooth API，请使用Chrome或Edge浏览器', 'warning', '浏览器不支持');
                    return;
                }
                
                updateConnectionStatus('connecting', 'bluetooth');
                
                // 请求蓝牙设备
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{
                        name: 'Led-Box-BLE'
                    }],
                    optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
                });
                
                // 连接到GATT服务器
                const server = await bluetoothDevice.gatt.connect();
                
                // 获取服务
                const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
                
                // 获取特征值
                bluetoothCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                
                // 启用通知以接收来自Arduino的数据
                console.log('启用蓝牙通知...');
                await bluetoothCharacteristic.startNotifications();
                console.log('蓝牙通知已启用');
                bluetoothCharacteristic.addEventListener('characteristicvaluechanged', handleBluetoothMessage);
                console.log('蓝牙消息监听器已添加');
                
                // 主动获取设备状态
                console.log('发送GET STATE命令获取设备状态');
                await sendBluetoothData('GET STATE');
                
                showToast('BLE连接成功！', 'success', '连接成功');
                
                // 更新连接状态
                updateConnectionStatus('connected', 'bluetooth');
                
                // 监听蓝牙设备断开
                bluetoothDevice.addEventListener('gattserverdisconnected', () => {
                    console.log('蓝牙设备断开连接');
                    bluetoothDevice = null;
                    bluetoothCharacteristic = null;
                    updateConnectionStatus('disconnected');
                    showToast('BLE设备已断开连接', 'warning', '连接断开');
                });
                
                // 启动蓝牙连接状态监控
                startBluetoothConnectionMonitor();
                
            } catch (error) {
                console.error('BLE操作失败:', error);
                updateConnectionStatus('disconnected');
                
                // 如果用户取消选择设备，不显示错误提示
                if (error.name !== 'NotFoundError' && !error.message.includes('User cancelled')) {
                    showCustomAlert('BLE操作失败: ' + error.message, 'error', '操作失败');
                }
            }
        });
        
        // 读取串口数据
        async function readSerialData() {
            if (!serialPort) return;
            
            try {
                serialReader = serialPort.readable.getReader();
                
                while (true) {
                    const { value, done } = await serialReader.read();
                    if (done) break;
                    
                    // 处理接收到的数据
                    const receivedData = new TextDecoder().decode(value);
                    console.log('收到串口数据:', receivedData);
                    
                    // 处理STATE消息
                    if (receivedData.includes('STATE,')) {
                        // 可能包含多行数据，需要分割处理
                        const lines = receivedData.split('\n');
                        for (const line of lines) {
                            if (line.trim().startsWith('STATE,')) {
                                handleStateMessage(line.trim());
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('读取串口数据失败:', error);
                
                // 检查是否是串口断开错误
                 if (error.name === 'NetworkError' || 
                     error.message.includes('device has been lost') ||
                     error.message.includes('device was disconnected') ||
                     error.message.includes('The device has been lost')) {
                     console.log('检测到串口设备断开');
                     serialPort = null;
                     serialReader = null;
                     updateConnectionStatus('disconnected');
                     // 移除USB断开的弹窗通知，只在控制台记录
                 }
            } finally {
                // 确保释放reader锁定
                if (serialReader) {
                    try {
                        serialReader.releaseLock();
                    } catch (e) {
                        console.log('Reader已经被释放');
                    }
                    serialReader = null;
                }
            }
        }
        
        // 发送串口数据
        async function sendSerialData(data) {
            if (!serialPort || !serialPort.writable) {
                console.error('串口未连接或不可写');
                return;
            }
            
            try {
                const writer = serialPort.writable.getWriter();
                const encoder = new TextEncoder();
                await writer.write(encoder.encode(data));
                writer.releaseLock();
                console.log('发送串口数据:', data);
            } catch (error) {
                console.error('发送串口数据失败:', error);
            }
        }
        
        // 发送蓝牙数据
        async function sendBluetoothData(data) {
            if (!bluetoothCharacteristic) {
                console.error('蓝牙特征值未连接');
                return;
            }
            
            try {
                const encoder = new TextEncoder();
                await bluetoothCharacteristic.writeValue(encoder.encode(data));
                console.log('发送蓝牙数据:', data);
            } catch (error) {
                console.error('发送蓝牙数据失败:', error);
            }
        }
        
        // 处理蓝牙接收到的消息
        function handleBluetoothMessage(event) {
            console.log('蓝牙消息事件触发');
            const receivedData = new TextDecoder().decode(event.target.value);
            console.log('收到蓝牙数据:', receivedData);
            console.log('数据长度:', receivedData.length);
            console.log('数据类型:', typeof receivedData);
            
            // 处理STATE消息
            if (receivedData.startsWith('STATE,')) {
                console.log('检测到STATE消息');
                handleStateMessage(receivedData);
            } else {
                console.log('收到其他蓝牙消息:', receivedData);
            }
        }
        
        // 处理Arduino发送的状态消息
        function handleStateMessage(stateMsg) {
            try {
                // 解析状态消息: STATE,isLightOn,isBreathing,r,g,b,brightness,periodMs
                const parts = stateMsg.split(',');
                if (parts.length !== 8 || parts[0] !== 'STATE') {
                    console.error('状态消息格式错误:', stateMsg);
                    return;
                }
                
                const [, isLightOn, isBreathing, r, g, b, brightness, periodMs] = parts;
                
                console.log('收到设备状态:', {
                    isLightOn: isLightOn === '1',
                    isBreathing: isBreathing === '1',
                    color: { r: parseInt(r), g: parseInt(g), b: parseInt(b) },
                    brightness: parseInt(brightness),
                    periodMs: parseInt(periodMs)
                });
                
                // 更新前端界面状态
                updateUIFromDeviceState({
                    isLightOn: isLightOn === '1',
                    isBreathing: isBreathing === '1',
                    r: parseInt(r),
                    g: parseInt(g),
                    b: parseInt(b),
                    brightness: parseInt(brightness),
                    periodMs: parseInt(periodMs)
                });
                
            } catch (error) {
                console.error('解析状态消息失败:', error, stateMsg);
            }
        }
        
        // RGB转HSL
        function rgbToHsl(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;
            
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0; // achromatic
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            
            return { h: h * 360, s: s * 100, l: l * 100 };
        }
        
        // 根据HSL值更新调色盘选择器位置
        function updateColorPickerPosition(r, g, b) {
            const hsl = rgbToHsl(r, g, b);
            const centerX = colorWheel.width / 2;
            const centerY = colorWheel.height / 2;
            const radius = Math.min(centerX, centerY) - 10;
            
            // 计算角度和距离
            const angle = (hsl.h / 360) * 2 * Math.PI;
            const distance = (hsl.s / 100) * radius;
            
            // 计算位置
            const x = centerX + Math.cos(angle) * distance;
            const y = centerY + Math.sin(angle) * distance;
            
            // 更新选择器位置
            colorPicker.style.left = x + 'px';
            colorPicker.style.top = y + 'px';
        }
        
        // 根据设备状态更新前端界面
        function updateUIFromDeviceState(state) {
            // 更新开关状态
            const ledSwitch = document.getElementById('ledSwitch');
            if (ledSwitch) {
                if (state.isLightOn) {
                    ledSwitch.setAttribute('data-state', 'on');
                    ledSwitch.className = 'switch-btn on';
                    ledSwitch.querySelector('.switch-text').textContent = '💡';
                } else {
                    ledSwitch.setAttribute('data-state', 'off');
                    ledSwitch.className = 'switch-btn off';
                    ledSwitch.querySelector('.switch-text').textContent = '💡';
                }
            }
            
            // 更新呼吸模式状态
            const breatheSwitch = document.getElementById('breatheSwitch');
            if (breatheSwitch) {
                if (state.isBreathing) {
                    breatheSwitch.setAttribute('data-state', 'on');
                    breatheSwitch.className = 'switch-btn on';
                    breatheSwitch.querySelector('.switch-text').textContent = '🌊';
                } else {
                    breatheSwitch.setAttribute('data-state', 'off');
                    breatheSwitch.className = 'switch-btn off';
                    breatheSwitch.querySelector('.switch-text').textContent = '🌊';
                }
            }
            
            // 更新亮度滑块
            const brightnessSlider = document.getElementById('brightness');
            const brightnessValue = document.getElementById('brightnessValue');
            if (brightnessSlider && brightnessValue) {
                const brightnessPercent = Math.round((state.brightness / 255) * 100);
                brightnessSlider.value = brightnessPercent;
                brightnessValue.textContent = brightnessPercent + '%';
            }
            
            // 更新呼吸周期滑块
            const periodSlider = document.getElementById('breathePeriod');
            const periodValue = document.getElementById('breathePeriodValue');
            if (periodSlider && periodValue) {
                periodSlider.value = state.periodMs;
                periodValue.textContent = state.periodMs + 'ms';
            }
            
            // 更新调色盘颜色和选择器位置
            const color = { r: state.r, g: state.g, b: state.b };
            updateColorDisplay(color);
            updateColorPickerPosition(state.r, state.g, state.b);
            
            console.log('界面状态已更新:', state);
        }
        
        // 蓝牙连接状态监控
        let bluetoothMonitorInterval = null;
        
        function startBluetoothConnectionMonitor() {
            // 清除之前的监控
            if (bluetoothMonitorInterval) {
                clearInterval(bluetoothMonitorInterval);
            }
            
            bluetoothMonitorInterval = setInterval(() => {
                if (bluetoothDevice && connectionType === 'bluetooth') {
                    // 检查蓝牙设备是否仍然连接
                    if (!bluetoothDevice.gatt.connected) {
                        console.log('检测到蓝牙设备已断开');
                        clearInterval(bluetoothMonitorInterval);
                        bluetoothMonitorInterval = null;
                        bluetoothDevice = null;
                        bluetoothCharacteristic = null;
                        updateConnectionStatus('disconnected');
                        showToast('BLE设备已断开连接', 'warning', '连接断开');
                    }
                } else {
                    // 如果不是蓝牙连接，停止监控
                    clearInterval(bluetoothMonitorInterval);
                    bluetoothMonitorInterval = null;
                }
            }, 1000); // 每1秒检查一次，平衡检测速度和连接稳定性
        }
        
        function stopBluetoothConnectionMonitor() {
            if (bluetoothMonitorInterval) {
                clearInterval(bluetoothMonitorInterval);
                bluetoothMonitorInterval = null;
            }
        }

        // 蓝牙设备断开处理
        function onBluetoothDisconnected() {
            console.log('蓝牙设备已断开');
            bluetoothDevice = null;
            bluetoothCharacteristic = null;
            
            stopBluetoothConnectionMonitor();
            updateConnectionStatus('disconnected');
            showToast('BLE设备已断开连接', 'warning', '连接断开');
        }
        
        // 自定义弹窗函数
        function showCustomAlert(message, type = 'info', title = '提示') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const modalIcon = document.getElementById('modalIcon');
                const modalTitle = document.getElementById('modalTitle');
                const modalMessage = document.getElementById('modalMessage');
                const confirmBtn = document.getElementById('modalConfirm');
                const cancelBtn = document.getElementById('modalCancel');
                
                // 设置图标和样式
                const icons = {
                    success: '✅',
                    error: '❌',
                    warning: '⚠️',
                    info: 'ℹ️'
                };
                
                modalIcon.textContent = icons[type] || icons.info;
                modalIcon.className = `modal-icon ${type}`;
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                
                // 隐藏取消按钮（只显示确定按钮）
                cancelBtn.style.display = 'none';
                
                // 显示弹窗
                modal.classList.add('show');
                
                // 确定按钮事件
                const handleConfirm = () => {
                    modal.classList.remove('show');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    resolve(true);
                };
                
                confirmBtn.addEventListener('click', handleConfirm);
                
                // 点击背景关闭
                const handleBackdrop = (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('show');
                        modal.removeEventListener('click', handleBackdrop);
                        resolve(true);
                    }
                };
                
                modal.addEventListener('click', handleBackdrop);
            });
        }
        
        // 自定义确认弹窗函数
        function showCustomConfirm(message, title = '确认') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const modalIcon = document.getElementById('modalIcon');
                const modalTitle = document.getElementById('modalTitle');
                const modalMessage = document.getElementById('modalMessage');
                const confirmBtn = document.getElementById('modalConfirm');
                const cancelBtn = document.getElementById('modalCancel');
                
                modalIcon.textContent = '❓';
                modalIcon.className = 'modal-icon warning';
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                
                // 显示取消按钮
                cancelBtn.style.display = 'inline-block';
                confirmBtn.textContent = '确定';
                cancelBtn.textContent = '取消';
                
                // 显示弹窗
                modal.classList.add('show');
                
                // 确定按钮事件
                const handleConfirm = () => {
                    modal.classList.remove('show');
                    cleanup();
                    resolve(true);
                };
                
                // 取消按钮事件
                const handleCancel = () => {
                    modal.classList.remove('show');
                    cleanup();
                    resolve(false);
                };
                
                // 点击背景关闭（相当于取消）
                const handleBackdrop = (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('show');
                        cleanup();
                        resolve(false);
                    }
                };
                
                const cleanup = () => {
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    modal.removeEventListener('click', handleBackdrop);
                };
                
                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
                modal.addEventListener('click', handleBackdrop);
            });
        }
        
        // 显示右上角通知
        function showToast(message, type = 'info', title = '', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            
            const iconMap = {
                success: '✅',
                info: 'ℹ️',
                warning: '⚠️',
                error: '❌'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${iconMap[type] || iconMap.info}</div>
                <div class="toast-content">
                    ${title ? `<div class="toast-title">${title}</div>` : ''}
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            container.appendChild(toast);
            
            // 触发显示动画
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // 自动隐藏
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 400);
            }, duration);
        }

        // 重写alert函数
        window.alert = function(message) {
            return showCustomAlert(message, 'info');
        };
        
        // 重写confirm函数
        window.confirm = function(message) {
            return showCustomConfirm(message);
        };

    </script>
    
    <!-- 自定义弹窗 -->
    <!-- 右上角通知容器 -->
    <div id="toastContainer"></div>

    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <span id="modalIcon" class="modal-icon">ℹ️</span>
            <div id="modalTitle" class="modal-title">提示</div>
            <div id="modalMessage" class="modal-message">这是一条消息</div>
            <div class="modal-buttons">
                <button id="modalConfirm" class="modal-btn primary">确定</button>
                <button id="modalCancel" class="modal-btn secondary" style="display: none;">取消</button>
            </div>
        </div>
    </div>
</body>
</html>